# 学习沉淀 - 2026-02-23

- 当 WebView 需要承载大型 Userscript 时，优先走“脚本原文 + GM 兼容层”方案，迭代速度远快于逐模块重写。
- `GM_xmlhttpRequest` 兼容不能只做字符串请求；至少要覆盖 `responseType: 'json'`、`FormData`、`withCredentials`，否则图床上传与第三方 API 功能会失效。
- 对 `@require` 外链脚本应提供双通道加载：先 `<script src>`，失败后走原生 Bridge 拉取并注入，能显著提升在 Android WebView 场景的成功率。
- `@JavascriptInterface` 回调中涉及 UI（如 Toast）必须切回主线程，避免线程上下文问题导致不稳定。
- WebView 若不接入 `WebChromeClient#onShowFileChooser`，Userscript 内部通过 `<input type=file>` 的上传能力基本不可用。
- 需要跨域请求且规避浏览器 CORS 时，原生 `HttpURLConnection` Bridge 是可行路径；同时要补 Cookie 透传与 `Set-Cookie` 回写，减少登录态丢失。
- 用户脚本配置入口在 App WebView 场景里不能依赖油猴菜单，应在网页可见区域增加“原位入口”（复用站点现有图标组与样式）以降低突兀感和学习成本。
- 若 Userscript 在 WebView 中“完全不生效”，优先怀疑 CSP/Host 白名单：避免通过 DOM 注入 `<script>`（可能被 CSP 阻断），改为 Bridge 拉取依赖并用 `eval/Function` 执行；同时 Bridge 请求要补默认浏览器 UA 降低 403 风控概率。
- 做“无突兀”UI 注入时，优先根据网页头部实际布局（`getBoundingClientRect`）动态定位图标组并同步颜色；避免把按钮塞进 `.floor-link-wrapper` 这类楼层/绝对定位容器，否则移动端容易遮挡原生控件。

- 小屏适配优先“单入口”：顶部只保留一个 Pro 菜单入口，将过滤/历史/关系/设置合并，避免多图标挤占头部导致错位与不可点。
- 移动端避免在楼层元信息行插入大段按钮导致挤压错位；改为“紧凑的 Lv/🍗/帖评信息直接显示”，并支持点击徽章展开详情/好友/屏蔽操作（减少突兀元素与误触）。
- 面板定位要做兜底：触发按钮被隐藏导致 `getBoundingClientRect()` 为 0 时，回退用 `#nsk-head` 的 bottom 作为计算基准。
- 高级设置面板小屏单栏化（隐藏左侧菜单、缩短 label 宽度、按钮栏 sticky），显著提升可用性。
- 小屏隐藏顶部图标时要避免误伤设置入口：若设置按钮复用了 `.history-dropdown-on` 这类 class，CSS 选择器需用 `:not(.nsx-settings-trigger)` 排除。
- 若脚本图标复用了 BASE_CSS 的 `height:56px!important` / `top:-7px!important`，在插入 `#nsk-head` 时可能把头部撑高并产生多余空白；应在 `#nsk-head` 作用域下用更高优先级 CSS 覆盖（如 `display:contents` + `height:100%`），保证与网页原生图标同高同对齐。
- 小屏内联信息如果用 `inline-flex` 包一整组徽章，容易在父容器是 flex/窄屏时“整组被挤到下一行”；可用 `display:contents` 让徽章与 meta 变成独立布局项分别换行，并把等级徽章改为“中性底色 + 渐变文字”以降低突兀感。
- 移动端作者行遇到“长纯数字 ID / 断词符（如 `<wbr>`）”时，若目标是隐藏长 ID，优先用 `text-overflow: ellipsis` + `white-space: nowrap` 截断，并在脚本中移除 `<wbr>` 避免被强制换行；横向滚动更适合“必须完整可见”的信息。

## 变更记录：移动端作者行隐藏长 ID（省略号 + 换行兜底）

### 背景
- 近期为了解决“长用户名/徽章/统计挤换行”的问题，引入了“仅当作者行发生换行时启用横向滚动”的方案（`nsx-author-nowrap`）。
- 但该方案会在触发条件时把“长纯数字 ID”完整暴露出来，和“隐藏长 ID”的诉求冲突。

### 目标
- 移动端作者行优先保持紧凑：用户名/ID 超长时用省略号截断，避免换行把信息挤乱。
- 保留“换行兜底”：当徽章/统计/楼层被挤到下一行时，启用单行横向滚动，确保作者行不掉行（同时用户名仍保持省略号）。

### 方案对比（结论：省略号为主，滚动为兜底）
- 省略号截断（默认）：信息密度更高、阅读更稳；需要提供 `title` 兜底让用户可长按/悬浮查看完整值。
- 横向滚动（仅在换行时启用）：主要用于“防掉行”；并不用于暴露完整长 ID（用户名链接本体仍保持省略号截断）。

### 实现要点
- CSS：在 `@media (max-width:768px)` 下，对 `.nsk-content-meta-info .author-info > a[href*="/space/"]` 及其子元素强制 `nowrap`，并对链接本体使用 `overflow:hidden + text-overflow:ellipsis + max-width:clamp(...)`。
- CSS（兜底）：当 `.author-info` 被标记为 `.nsx-author-nowrap` 时，强制 `flex-wrap:nowrap` 并开启 `overflow-x:auto`，让徽章/统计保持单行可滑动；同时让作者链接保留 `flex-shrink`，避免长 ID 在滚动模式下“变成可横向完整露出”。
- JS：窄屏下移除用户名节点内的 `<wbr>`（避免被站点断词策略强制换行），并补齐 `title` 作为完整值的可达性兜底。
- JS（兜底）：检测作者行是否发生换行（徽章/统计掉到下一行），若发生则给 `.author-info` 加 `.nsx-author-nowrap`。

### 验收要点
- 在宽度 ≤ 768px 的 WebView/浏览器下，长纯数字 ID 不再横向滚动露出全量内容，而是以省略号显示。
- Lv/统计等徽章在多数场景不被挤到下一行；若仍发生换行，会自动启用单行横向滚动兜底，避免作者行掉行。
