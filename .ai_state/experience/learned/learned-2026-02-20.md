# 学习沉淀 - 2026-02-20

- 采用 TWA + android-browser-helper 作为 PWA 容器，性能与省电最佳。
- 关键元数据：DEFAULT_URL 与 asset_statements，需要站点配置 assetlinks.json 才能全屏无地址栏。
- 构建依赖：AGP 8.13.2 + Gradle 8.13；minSdk 29 以满足 Android 10。
- 兼容策略：通过 FALLBACK_STRATEGY=webview + WebViewFallbackActivity 实现 TWA 不可用时回退。
- 实测：站点主页可加载，但未发现 manifest，assetlinks 端点返回 404。
- 构建落地：加入 Gradle Wrapper（8.13）与 build.bat，一键构建默认走 assembleDebug。
- 环境落地：自动下载 Android 命令行工具并安装 platform-tools、platforms;android-35、build-tools;35.0.0。
- 依赖约束：androidbrowserhelper 2.6.2 固定依赖 androidx.browser 1.9.0-alpha04，需要 compileSdk>=36。
- 兼容修复：使用官方 Gradle 8.13 生成 Wrapper，避免手工拼装 jar 导致缺类。
- 构建修复：build.bat 需 pushd 到脚本目录，否则 Gradle 识别不到 settings.gradle。
- 签名发布：keystore.properties 使用相对路径，storeFile 需用 rootProject.file 解析。
- 构建验证：release 构建已通过，产物在 app/build/outputs/apk/release。
- 方案切换：移除 TWA 依赖与清单元数据，改为原生 WebView 客户端并保持外链跳转系统浏览器。
- 交互增强：SwipeRefreshLayout 包裹 WebView，实现下拉刷新并在加载结束/错误时收起指示器。
- 状态栏适配：页面加载完成后读取 theme-color 或 body 背景色并同步状态栏与图标明暗。
- 版本更新：构建前同步 versionCode/versionName，便于发布与排查。
- 图标替换：从 512x512 源图生成各密度 mipmap 图标并切换 manifest 引用。
- 状态栏策略：优先取页面顶部元素背景色，其次 body 背景，最后才使用 theme-color。
- 警告控制：设置 org.gradle.warning.mode=none 以隐藏 Gradle deprecation 输出。
- 真修复路径：移除 SuppressWarnings 与 warning.mode=none，保留警告输出以追踪真实弃用来源。
- 状态栏实现：改为 edge-to-edge + 状态栏占位层（insets 高度），避免调用过时的 setStatusBarColor。
- 返回键实现：改用 Activity onKeyDown 处理 BACK 并回退历史，避免覆写过时 onBackPressed。
- 半原生路线拆分：先做 M0-M1-M2（壳层稳定）再推进 M3-M5（功能替换），每个里程碑都必须带可回滚与降级策略。
- M0 基线实践：先统一日志Tag（`NS_BASELINE`）记录冷启动首屏与恢复耗时，再做真机多次采样，避免“有结论无数据”。
- M1 导航壳实践：优先复用站点真实路由（如 `/categories/daily`），避免自造路径导致404；导航状态由 URL 反推并统一高亮。
- WebView半原生去重：通过注入定向CSS隐藏网页 `header`、左右面板与列表控制条，保留主帖子流，能快速消除“双导航”冲突并减少后续原生替换成本。
- 移动端一致性校验：重构前先用移动端UA（Android 10 + Mobile Chrome UA）抓DOM，再按真实结构调整隐藏选择器，避免“桌面DOM判断正确、手机实际错位”。
- 导航重构优先级：先固定“单一入口”（顶部栏），再接入抽屉与分类下拉；保留原 WebView 内容流，避免多导航并存导致认知冲突。
- 交互修复原则：若网页头部被隐藏，顶部搜索按钮不能再依赖 DOM 聚焦，应切换为原生输入弹窗，再映射到站点可用搜索路由（`/search?q=`）。
- 去套壳迁移策略：先用 Jsoup 拉取列表与详情文本，快速去掉 WebView 主流程；后续再逐步补评论、分页和缓存，风险最小且可持续演进。
- 403规避策略：当主站HTML被风控拦截时，优先切换到可公开访问的 `rss.nodeseek.com` 作为数据源，再在客户端做分类/搜索过滤，保证首版可用性。
- UA边界策略：MCP/自动化浏览器的 UA 配置与 App 内网络/WebView UA 必须分离管理，用户明确指定“只改调用端”时不能连带修改客户端默认 UA。
- 非RSS可用性策略：当用户明确放弃 RSS 时，首页应回退到登录态 WebView 主流程（抽屉分类+搜索+下拉刷新），以可用优先；403 仍受站点风控策略约束，客户端只能提示与降级，不能承诺规避。
- 去壳伪装策略：当用户要求“仅保留内容流”时，可在 `onPageFinished` 注入 JS 并挂 `MutationObserver` 持续隐藏网页头部/侧栏，同时将主内容容器强制扩展为全宽，避免 SPA 重渲染后导航复现。
- 美化优先策略：当用户要求“网页结构不变”时，注入逻辑应只改视觉细节（背景、卡片圆角、触控反馈、图像自适应），禁止隐藏导航结构，避免功能入口被误删。
- WebView 下拉刷新稳定性：`SwipeRefreshLayout` 的滚动判定应使用 `canScrollVertically(-1)`，不要依赖 `getScrollY()`；刷新当前页优先用 `webView.reload()`，仅在 URL 为空时回退 `loadUrl(home)`。
- WebView 真刷新策略：若出现“刷新转圈但内容不更新”，可在刷新 URL 追加时间戳参数（如 `_refresh_ts`）触发强制重载，并用超时兜底自动收起刷新指示器，避免卡住。
- 注入脚本稳定性：避免在 `MutationObserver` 回调里修改同一观察树（如反复写入 `style.textContent`），否则会产生高频回调循环，造成页面交互卡死；优先使用有限次数 `setTimeout` 重试注入。
- 风控敏感场景：若站点已出现拦截页，应立即停用所有注入与“时间戳强刷”手段，回退到最朴素 WebView + `reload()`，先降低额外请求特征与异常行为。
- 加载反馈策略：在 WebView 首页可只保留下拉刷新指示器，移除中心文案型“正在加载”提示，减少遮挡和视觉干扰，同时不影响错误提示文案显示。
- 状态栏一体化策略：在 `onPageFinished` 用 JS 读取 `theme-color`→顶部命中元素背景→header/body 背景并回传给原生，动态设置状态栏占位色和图标明暗，可在不改网页结构前提下实现“状态栏与页面顶区一体”。
- 状态栏防误跟随策略：对“绿色主导”颜色增加过滤（如抽屉/局部头图色），命中后回退白色，可避免状态栏被局部主题色污染而与整体页面不协调。
- CI 自动化落地：在 `.github/workflows/android-build.yml` 增加 `assembleDebug` 流程并上传 APK artifact，可在无本地环境时通过 GitHub Actions 远程拿包验证。
- 分发体验优化：在 CI 末尾用 `gh release` 维护固定 tag（`latest-debug`）并覆盖上传 `app-debug.apk`，可提供“无需解压 artifact”的直接下载链接。
- 主题协同策略：原生壳层通过 `values/` + `values-night/` 跟随系统明暗；同时在主题中关闭 `forceDarkAllowed`，避免 WebView 被系统强制反色，保留站点右上角手动主题切换作为唯一网页主题入口。
- 主题自动联动策略：在 `onPageFinished/onResume` 注入 JS，先识别网页当前明暗状态（`data-theme/class/theme-color/顶部背景`），与系统主题不一致时自动点击网页主题按钮；若按钮晚于首屏渲染再出现，按短延迟重试 2 次以提高命中率。
- NodeSeek 当前真实主题按钮为 `.color-theme-switcher`（`div` 非 `button/a`）；切换后 `body` 会在 `dark-layout` / `light-layout` 间变化，图标 `use[href]` 在 `#moon` / `#sun-one` 间切换。
- README 规范化建议：按“特性→环境→构建→CI→FAQ→免责声明”结构组织，并在构建章节同时给出 Unix 与 Windows 命令，降低上手成本。
